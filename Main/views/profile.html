<div class="section">
  <!-- container -->
  <div class="container">
    <div class="container-fluid mt-4">
      <div class="row">

        <!-- Sidebar Accordion -->
        <div class="col-md-3 order-details">
          <div class="card shadow-sm border-0">
            <ul class="list-group list-group-flush">
              <li class="list-group-item border-0" ng-click="activeView = 'profile'"
                ng-class="{ 'bg-primary text-white': activeView === 'profile' }" style="cursor: pointer;">
                <strong class="ProfileStrong">Profile</strong>
              </li>
              <li class="list-group-item border-0" ng-click="activeView = 'address'"
                ng-class="{ 'bg-primary text-white': activeView === 'address' }" style="cursor: pointer;">
                <strong class="ProfileStrong">Address</strong>
              </li>
              <li class="list-group-item border-0" ng-click="activeView = 'purchases'"
                ng-class="{ 'bg-primary text-white': activeView === 'purchases' }" style="cursor: pointer;">
                <strong class="ProfileStrong">My Purchases</strong>
              </li>
            </ul>
          </div>
        </div>



        <!-- Main Content Area -->
        <div class="col-md-9">

          <!-- Profile View -->
          <div ng-show="activeView === 'profile'">
            <!-- Billing Details -->
            <div class="billing-details">
              <div class="section-title row" style="margin-bottom:15px;">
                <div class="col-xs-6">
                  <h3 class="title" style="margin:0;">Profile</h3>
                </div>
              </div>

              <!-- Name -->
              <div class="form-group">
                <label>Name</label>
                <input type="text" class="form-control" ng-model="user.name"
                  ng-class="{'is-invalid': showErrors && !user.name}">
                <div class="text-danger" ng-show="showErrors && !user.name">Name is required.</div>
              </div>

              <!-- Email -->
              <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-control" ng-model="user.email"
                  ng-class="{'is-invalid': showErrors && !user.email}">
                <div class="text-danger" ng-show="showErrors && !user.email">Valid email is required.</div>
              </div>
			  
			   <!-- Phone Number -->
              <div class="form-group">
                <label>Phone Number</label>
                <input type="text" class="form-control" ng-model="user.phonenumber"
				 ng-class="{'is-invalid': showErrors && !user.phonenumber}">
              </div>
			  
			  <!-- Address -->
              <div class="form-group">
                <label>Address</label>
                <input type="text" class="form-control" ng-model="user.Address"
				 ng-class="{'is-invalid': showErrors && !user.Address}">
              </div>

              <!-- Password Section -->
              <div class="row" style="margin-bottom:15px;">
                <div class="col-xs-6">
                  <label style="margin-top:5px;">Password</label>
                </div>
                <div class="col-xs-6 text-right">
                  <a class="btn btn-link" type="button" data-toggle="modal" data-target="#passwordModal">
                    Change
                  </a>
                </div>
              </div>

              <!-- Save Button -->
              <div class="text-center">
                <button class="btn btn-primary" ng-click="onsubmit()">Save</button>
              </div>

              <!-- Password Modal -->
              <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content" ng-controller="ProfileController">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                        ng-click="cancelChangePassword()">
                        <span aria-hidden="true">&times;</span>
                      </button>
                      <h4 class="modal-title" id="passwordModalLabel">Change Password</h4>
                    </div>

                    <div class="modal-body">
                      <!-- Old Password -->
                      <div class="form-group">
                        <label>Old Password</label>
                        <input type="password" class="form-control" ng-model="user.oldPassword"
                          ng-class="{'is-invalid': showErrors && (!user.oldPassword || passwordErrors.oldPassword)}">
                        <div class="text-danger" ng-show="showErrors && !user.oldPassword">Old password is required.
                        </div>
                        <div class="text-danger" ng-show="passwordErrors.oldPassword">{{ passwordErrors.oldPassword }}
                        </div>
                      </div>

                      <!-- New Password -->
                      <div class="form-group">
                        <label>New Password</label>
                        <input type="password" class="form-control" ng-model="user.newPassword"
                          ng-class="{'is-invalid': showErrors && !user.newPassword}">
                        <div class="text-danger" ng-show="showErrors && !user.newPassword">New password is required.
                        </div>
                      </div>

                      <!-- Confirm Password -->
                      <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" class="form-control" ng-model="user.confirmPassword"
                          ng-class="{'is-invalid': showErrors && (!user.confirmPassword || passwordErrors.confirmPassword)}">
                        <div class="text-danger" ng-show="showErrors && !user.confirmPassword">Confirm password is
                          required.</div>
                        <div class="text-danger" ng-show="passwordErrors.confirmPassword">{{
                          passwordErrors.confirmPassword }}</div>
                      </div>
                    </div>

                    <div class="modal-footer">
                      <button class="btn btn-default" data-dismiss="modal"
                        ng-click="cancelChangePassword()">Cancel</button>
                      <button class="btn btn-primary" ng-click="submitPassword()">Save Password</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Address View -->
          <div ng-show="activeView === 'address'">
            <div class="row mb-3">
              <div class="col-xs-6">
                <h4 class="m-0">Address</h4>
              </div>
              <div class="col-xs-6 text-right">
                <button type="button" class="btn btn-primary btn-round" data-toggle="modal"
                  data-target="#UserShippingDetailsCreateModal" ng-click="addUserShippingDetailsOnClick()">
                  <i class="fa fa-plus"></i> Add Shipping Details
                </button>
              </div>
            </div>

            <div class="add-user-btn-container d-flex justify-content-between align-items-center mb-3">
              <input class="form-control w-auto" type="text" placeholder="Search" ng-model="searchQuery">
            </div>

            <!-- Add/Edit Shipping Details Modal -->
            <div class="modal fade" id="UserShippingDetailsCreateModal" tabindex="-1" role="dialog"
              aria-labelledby="UserShippingDetailsCreateModalLabel" aria-hidden="true" data-backdrop="static"
              data-keyboard="false">
              <div class="modal-dialog">
                <div class="modal-content">

                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                      ng-click="updateUserShippingDetailsFields()">
                      <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="UserShippingDetailsCreateModalLabel">
                      {{ usershippingdetail.user_shipping_id ? 'Edit Shipping Details' : 'Add Shipping Details' }}
                    </h4>
                  </div>

                  <div class="modal-body">

                    <div class="form-group">
                      <label for="fullname">Full Name</label>
                      <input type="text" id="fullname" class="form-control" ng-model="usershippingdetail.fullname"
                        ng-blur="validateName()" placeholder="Enter Full Name">
                      <span ng-show="nameHasError" class="text-danger small">
                        {{ nameError }}
                      </span>
                    </div>

                    <div class="form-group">
                      <label for="phonenumber">Phone Number</label>
                      <input type="text" id="phonenumber" class="form-control" ng-model="usershippingdetail.phonenumber"
                        ng-init="usershippingdetail.phonenumber = '+63 '" ng-change="forcePrefix()"
                        ng-blur="validatePhoneNumber()" maxlength="17" placeholder="+63 912 345 6789">
                      <span ng-show="PhoneNumberHasError" class="text-danger small">
                        Phone Number is required.
                      </span>
                    </div>

                    <div class="form-group">
                      <label for="address">Address</label>
                      <input type="text" id="address" class="form-control" ng-model="usershippingdetail.address"
                        ng-blur="validateAddress()" placeholder="Enter Address">
                      <span ng-show="AddressHasError" class="text-danger small">
                        Address is required.
                      </span>
                    </div>

                    <div class="form-group">
                      <label for="municipality">Municipality</label>
                      <select class="input-select" id="municipality" ng-change="validateMunicipality()"
                            ng-model="usershippingdetail.Muni_ID"
                            ng-options="municipality.Muni_ID as municipality.Muni_Name for municipality in muniAlllist">
                            <option value="">-- Select Municipality --</option>
                        </select>
                        <span ng-show="selectedMuniIdHasError" style="color: red; font-size: 0.9em;">
                            Municipality is required.
                        </span>
                    </div>

                    <div class="form-group">
                      <label for="barangay">Barangay</label>
                      <select class="input-select" id="barangay" ng-change="validateBarangay()"
                            ng-model="usershippingdetail.Brgy_ID"
                            ng-options="barangay.Brgy_ID as barangay.Brgy_Name for barangay in brgyAlllist | filter:{Muni_ID: usershippingdetail.Muni_ID}">
                            <option value="">-- Select Barangay --</option>
                        </select>
                        <span ng-show="selectedBrgyIdHasError" style="color: red; font-size: 0.9em;">
                            Barangay is required.
                        </span>
                    </div>


                    <div class="form-group">
                      <label for="postalcode">Postal Code</label>
                      <input type="text" id="postalcode" class="form-control" ng-model="usershippingdetail.postalcode"
                        ng-blur="validatePostalCode()" placeholder="Enter Postal Code">
                      <span ng-show="PostalCodeHasError" class="text-danger small">
                        Postal Code is required.
                      </span>
                    </div>

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" name="is_default_address"
                          ng-model="usershippingdetail.is_default_address">
                        Default Shipping Address
                      </label>
                    </div>

                  </div>

                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                      ng-click="updateUserShippingDetailsFields()">
                      Cancel
                    </button>
                    <button type="button" class="btn btn-primary" ng-click="submit()" data-dismiss="modal">
                      {{ usershippingdetail.user_shipping_id ? 'Save' : 'Create' }}
                    </button>
                  </div>

                </div>
              </div>
            </div>


            <!-- Delete Confirmation Modal -->
            <div class="modal fade" id="deleteUserShippingDetailsConfirmationModal" tabindex="-1" role="dialog"
              aria-labelledby="deleteUserShippingDetailsConfirmationModalLabel" aria-hidden="true"
              data-backdrop="static">
              <div class="modal-dialog">
                <div class="modal-content">

                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="deleteUserShippingDetailsConfirmationModalLabel">
                      Delete Shipping Details
                    </h4>
                  </div>

                  <div class="modal-body">
                    <p>Are you sure you want to delete this shipping detail?</p>
                  </div>

                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                      No
                    </button>
                    <button type="button" class="btn btn-primary" ng-click="deleteUserShippingDetailsById()"
                      data-dismiss="modal">
                      Yes
                    </button>
                  </div>

                </div>
              </div>
            </div>


            <!-- Address Table -->
            <form ng-submit="save()">
              <table class="table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Full Name</th>
                    <th>Phone Number</th>
                    <th>Address</th>
                    <th>Municipality</th>
                    <th>Barangay</th>
                    <th>Postal Code</th>
                    <th>Default</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="detail in usershippingdetails | filter:searchQuery">
                    <td>{{ ($index + 1) + ((pagination.page - 1) * pagination.limit) }}</td>
                    <td>{{ detail.fullname }}</td>
                    <td>{{ detail.phonenumber }}</td>
                    <td>{{ detail.address }}</td>
                    <td>{{ detail.Muni_Name }}</td>
                    <td>{{ detail.Brgy_Name }}</td>
                    <td>{{ detail.postalcode }}</td>
                    <td>{{ detail.Def_Address }}</td>
                    <td>
                      <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-primary"
                          ng-click="updateUserShippingDetailsOnClick(detail)" data-toggle="modal"
                          data-target="#UserShippingDetailsCreateModal">
                          <i class="fa fa-edit" title="Update"></i>
                        </button>

                        <button type="button" class="btn btn-danger btn-sm" data-toggle="modal"
                          data-target="#deleteUserShippingDetailsConfirmationModal"
                          ng-click="deleteUserShippingDetailsOnClick(detail)">
                          <i class="fa fa-times"></i> Delete
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </form>

            <!-- Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <label>
                  Show
                  <select ng-model="pageSize" ng-change="changePageSize()"
                    ng-options="s for s in [5, 10, 25, 50]"></select>
                  entries
                </label>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary" ng-disabled="pagination.page === 1"
                  ng-click="loadTransactions(pagination.page - 1)">
                  Prev
                </button>
                Page {{ pagination.page }} of {{ pagination.totalPages }}
                <button class="btn btn-sm btn-outline-primary" ng-disabled="pagination.page === pagination.totalPages"
                  ng-click="loadTransactions(pagination.page + 1)">
                  Next
                </button>
              </div>
            </div>
          </div>





          <div ng-show="activeView === 'purchases'">
            <h3>My Purchases</h3>

            <div style="margin-top:20px;">

              <!-- Tabs -->
              <ul class="nav nav-tabs" style="margin-bottom:20px;">
                <li ng-class="{active: activeTab === 'toShip'}">
                  <a ng-click="activeTab = 'toShip'" style="cursor:pointer;">To Ship</a>
                </li>
                <li ng-class="{active: activeTab === 'toReceive'}">
                  <a ng-click="activeTab = 'toReceive'" style="cursor:pointer;">To Receive</a>
                </li>
                <li ng-class="{active: activeTab === 'completed'}">
                  <a ng-click="activeTab = 'completed'" style="cursor:pointer;">Completed</a>
                </li>
              </ul>

              <!-- Initialize Filtered Arrays -->
              <div ng-init="toShipOrders = (orders | filter:{order_status_name: 'Pending'})"></div>
              <div ng-init="toReceiveOrders = (orders | filter:{order_status_name: 'Shipped'})"></div>
              <div ng-init="completedOrders = (orders | filter:{order_status_name: 'Paid'})"></div>

              <!-- ===================== TO SHIP ===================== -->
              <div ng-show="activeTab === 'toShip'">
                <h4>To Ship</h4>

                <div ng-if="toShipOrders.length === 0" class="text-center text-muted" style="margin-top:20px;">
                  <p>No orders to ship at the moment.</p>
                </div>

                <div class="panel-group" id="toShipAccordion">
                  <div class="panel panel-default" ng-repeat="order in orders | filter:{order_status_name: 'Pending'} track by $index">
                    <div class="panel-heading">
                      <h4 class="panel-title">
                        <a href="" ng-click="togglePanel('toShip', $index, $event)"
                          ng-class="{'collapsed': !isPanelOpen('toShip', $index)}"
                          aria-expanded="{{ isPanelOpen('toShip', $index) ? 'true' : 'false' }}"
                          style="cursor:pointer; display:block;">
                          Order #{{ order.order_id }}
                          <span class="pull-right"><i class="fa"
                              ng-class="{'fa-chevron-up': isPanelOpen('toShip',$index), 'fa-chevron-down': !isPanelOpen('toShip',$index)}"></i></span>
                        </a>
                      </h4>
                    </div>

                    <div class="panel-collapse collapse" ng-class="{'in': isPanelOpen('toShip', $index)}">
                      <div class="panel-body">
                        <div class="row" ng-repeat="item in order.items" style="margin-bottom:15px;">
                          <div class="col-sm-3">
                            <img
                              ng-src="{{ (item.item_img_loc ? ('../BackOffice/uploads/' + item.item_img_loc) : 'assets/img/default.jpg') }}"
                              class="img-responsive img-thumbnail" alt="{{ item.item_brand_name }}">
                          </div>
                          <div class="col-sm-6">
                            <h5>{{ item.item_brand_name }} - {{ item.item_category_name }}</h5>
                            <p class="text-muted">Qty: {{ item.item_qty }} × ₱{{ item.item_price }}</p>
                          </div>
                          <div class="col-sm-3 text-right">
                            <strong>₱{{ item.item_total_amt | number:2 }}</strong>
                          </div>
                        </div>

                        <hr>
                        <div class="text-right">
                          <h5>Shipping Fee: ₱{{ order.shipRates | number:2 }}</h5>
                          <h5>Total: ₱{{ getTotal(order.items, order.shipRates) | number:2 }}</h5>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ===================== TO RECEIVE ===================== -->
              <div ng-show="activeTab === 'toReceive'">
                <h4>To Receive</h4>
                <div ng-if="toReceiveOrders.length === 0" class="text-center text-muted" style="margin-top:20px;">
                  <p>No orders to receive at the moment.</p>
                </div>

                <div class="panel-group" id="toReceiveAccordion">
                  <div class="panel panel-default"
                    ng-repeat="order in orders | filter:{order_status_name: 'To Ship'} track by $index">
                    <div class="panel-heading">
                      <h4 class="panel-title">
                        <a href="" ng-click="togglePanel('toReceive', $index, $event)"
                          ng-class="{'collapsed': !isPanelOpen('toReceive', $index)}"
                          aria-expanded="{{ isPanelOpen('toReceive', $index) ? 'true' : 'false' }}"
                          style="cursor:pointer; display:block;">
                          Order #{{ order.order_id }}
                          <span class="pull-right"><i class="fa"
                              ng-class="{'fa-chevron-up': isPanelOpen('toReceive',$index), 'fa-chevron-down': !isPanelOpen('toReceive',$index)}"></i></span>
                        </a>
                      </h4>
                    </div>

                    <!-- use Bootstrap 3 'in' to show -->
                    <div class="panel-collapse collapse" ng-class="{'in': isPanelOpen('toReceive', $index)}">
                      <div class="panel-body">
                        <div class="row" ng-repeat="item in order.items" style="margin-bottom:15px;">
                          <div class="col-sm-3">
                            <img
                              ng-src="{{ (item.item_img_loc ? ('../BackOffice/uploads/' + item.item_img_loc) : 'assets/img/default.jpg') }}"
                              class="img-responsive img-thumbnail" alt="{{ item.item_brand_name }}">
                          </div>
                          <div class="col-sm-6">
                            <h5>{{ item.item_brand_name }} - {{ item.item_category_name }}</h5>
                            <p class="text-muted">Qty: {{ item.item_qty }} × ₱{{ item.item_price }}</p>
                          </div>
                          <div class="col-sm-3 text-right">
                            <strong>₱{{ item.item_total_amt | number:2 }}</strong>
                          </div>
                        </div>

                        <hr>
                        <div class="row">
                          <div class="col-xs-6 text-left">
                            <h5>Shipping Fee: ₱{{ order.shipRates | number:2 }}</h5>
                            <h5>Total: ₱{{ getTotal(order.items, order.shipRates) | number:2 }}</h5>
                          </div>
                          <div class="col-xs-6 text-right">
                            <button class="btn btn-primary btn-sm" ng-click="markAsReceived(order)">Received</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>



              <!-- ===================== COMPLETED ===================== -->
              <div ng-show="activeTab === 'completed'">
                <h4>Completed</h4>
                <div ng-if="completedOrders.length === 0" class="text-center text-muted" style="margin-top:20px;">
                  <p>No completed orders at the moment.</p>
                </div>

                <div class="panel-group" id="completedAccordion">
                  <div class="panel panel-default"
                    ng-repeat="order in orders | filter:{order_status_name: 'Paid'} track by $index">
                    <div class="panel-heading">
                      <h4 class="panel-title">
                        <!-- Prevent hash redirect -->
                        <a href="" ng-click="togglePanel('completed', $index, $event)"
                          ng-class="{'collapsed': !isPanelOpen('completed', $index)}"
                          aria-expanded="{{ isPanelOpen('completed', $index) ? 'true' : 'false' }}"
                          style="cursor:pointer; display:block;">
                          Order #{{ order.order_id }} - {{ order.order_created_at }}
                          <span class="pull-right">
                            <i class="fa"
                              ng-class="{'fa-chevron-up': isPanelOpen('completed', $index), 'fa-chevron-down': !isPanelOpen('completed', $index)}"></i>
                          </span>
                        </a>
                      </h4>
                    </div>

                    <div class="panel-collapse collapse" ng-class="{'in': isPanelOpen('completed', $index)}">
                      <div class="panel-body">

                        <div class="row" ng-repeat="item in order.items" style="margin-bottom:15px;">
                          <div class="col-sm-3">
                            <img
                              ng-src="{{ (item.item_img_loc ? ('../BackOffice/uploads/' + item.item_img_loc) : 'assets/img/default.jpg') }}"
                              class="img-responsive img-thumbnail" alt="{{ item.item_brand_name }}">
                          </div>
                          <div class="col-sm-6">
                            <h5>{{ item.item_brand_name }} - {{ item.item_category_name }}</h5>
                            <p class="text-muted">Qty: {{ item.item_qty }} × ₱{{ item.item_price }}</p>
                          </div>
                          <div class="col-sm-3 text-right">
                            <strong>₱{{ item.item_total_amt | number:2 }}</strong>
                          </div>
                        </div>

                        <hr>
                        <div class="text-right">
                          <h5>Shipping Fee: ₱{{ order.shipRates | number:2 }}</h5>
                          <h5>Total: ₱{{ getTotal(order.items, order.shipRates) | number:2 }}</h5>
                        </div>

                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- End Completed -->


            </div> <!-- End Container -->
          </div>




        </div> <!-- End col-md-9 -->
      </div> <!-- End row -->
    </div> <!-- End container-fluid -->
  </div>
</div>